<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">



<mapper namespace="com.example.demo.repository.TimeRepository">
	<!-- **************** 一覧全件検索 **************** -->
	<!-- 一覧検索 -->
	<resultMap type="com.example.demo.entity.TimeLog"
		id="logList">
		<id property="logId" column="log_id" />
		<result property="categoryName" column="category_name" />
		<result property="endTime" column="end_time" />
		<result property="startTime" column="start_time_str" />
		<result property="userId" column="user_id" />
		<result property="categoryId" column="category_id" />
		
	</resultMap>
	<select id="selectListAll"
		resultType="com.example.demo.entity.TimeLog" resultMap="logList">
		SELECT log_id,
		category_name,start_time AS
		start_time_str,
		 end_time AS end_time, user_id,
		log.category_id
		FROM log LEFT JOIN category ON log.category_id =
		category.category_id
		LEFT JOIN user ON log.user_id = user.id 
		WHERE STR_TO_DATE(start_time, '%Y-%m-%d') = CURDATE()
		ORDER BY
		start_time
	</select>

	<insert id="insert"> INSERT INTO log (start_time, end_time,category_id )
		VALUES ( #{log.startTime}, #{log.endTime}, #{log.categoryId} )
	</insert>
	<resultMap type="com.example.demo.entity.LogDetail"
		id="logDetail">
		<id property="logId" column="log_id" />
		<result property="endTime" column="end_time" />
		<result property="startTime" column="start_time_str" />
		<association property="category"
			javaType="com.example.demo.entity.Category">
			<id property="categoryId" column="category_id" />
			<result property="categoryName" column="category_name" />
		</association>

	</resultMap>
	<select id="selectByLogId" resultMap="logDetail">
		SELECT log_id,
		category_name,start_time AS
		start_time_str,
		end_time AS
		end_time,log.category_id FROM log
		INNER JOIN category ON
		log.category_id = category.category_id LEFT JOIN
		user ON log.user_id =
		user.id WHERE log_id = #{logId} ORDER BY log_id
	</select>

	<update id="update">
		UPDATE
		log
		SET
		category_id= #{log.categoryId},
		start_time = #{log.startTime},
		end_time = #{log.endTime}

		WHERE
		log_id = #{log.logId}
	</update>
	
	<delete id="delete">
		DELETE
		FROM
			log
		WHERE
			log_id = #{logId}
	</delete>
	
	<resultMap type="com.example.demo.entity.TimeLog"
		id="changeDay">
		<id property="logId" column="log_id" />
		<result property="categoryName" column="category_name" />
		<result property="endTime" column="end_time" />
		<result property="startTime" column="start_time_str" />
		<result property="userId" column="user_id" />
		<result property="categoryId" column="category_id" />
		
	</resultMap>
	<select id="selectByNowDay"
		resultType="com.example.demo.entity.TimeLog" resultMap="changeDay">
		SELECT log_id,
		category_name,start_time AS
		start_time_str,
		end_time AS end_time, user_id,
		log.category_id
		FROM log LEFT JOIN category ON log.category_id =
		category.category_id
		LEFT JOIN user ON log.user_id = user.id 
		WHERE STR_TO_DATE(start_time, '%Y-%m-%d') = #{nowDay}
		ORDER BY
		log_id
	</select>
	
	<resultMap type="com.example.demo.entity.MaxDay"
		id="maxEndTimeDay">
		
		<result property="maxDay" column="maxDay" />

		
	</resultMap>
	<select id="maxDay"
		resultType="com.example.demo.entity.MaxDay" resultMap="maxEndTimeDay">
		SELECT 
		MAX(end_time) AS maxDay
		FROM log 
		WHERE STR_TO_DATE(end_time, '%Y-%m-%d') = #{nowDay}
		
		
	</select>
	

</mapper>